{% extends "Back/Patient/base.html" %}

{% block title %}Manage appointment - {{ object.name }}{% endblock %}
{% block page_title %}Manage appointment{% endblock %}

{% block extra_css %}
<style>
  .prescription-form {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background-color: #f8f9fa;
  }
  .prescription-form.to-delete {
    opacity: 0.5;
    background-color: #ffe0e0;
  }
  .prescription-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .prescription-number {
    font-weight: 600;
    color: #0d6efd;
  }
  .btn-remove-prescription {
    padding: 4px 8px;
    font-size: 0.875rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-body">
        <h4 class="card-title mb-4">Update appointment & prescriptions</h4>
        <form method="post" class="row g-3" id="appointment-form">
          {% csrf_token %}
          
          <!-- Appointment Fields -->
          <div class="col-12">
            <h5 class="border-bottom pb-2 mb-3">Appointment Details</h5>
          </div>
          
          <div class="col-md-6">
            <label class="form-label fw-semibold">{{ form.status.label }}</label>
            {{ form.status }}
            {% if form.status.help_text %}
            <div class="form-text">{{ form.status.help_text }}</div>
            {% endif %}
            {% for error in form.status.errors %}
            <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">{{ form.linked_patient.label }}</label>
            {{ form.linked_patient }}
            {% if form.linked_patient.help_text %}
            <div class="form-text">{{ form.linked_patient.help_text }}</div>
            {% endif %}
            {% for error in form.linked_patient.errors %}
            <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="col-12">
            <label class="form-label fw-semibold">{{ form.patient_notes.label }}</label>
            {{ form.patient_notes }}
            {% if form.patient_notes.help_text %}
            <div class="form-text">{{ form.patient_notes.help_text }}</div>
            {% endif %}
            {% for error in form.patient_notes.errors %}
            <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="col-12">
            <label class="form-label fw-semibold">{{ form.doctor_notes.label }}</label>
            {{ form.doctor_notes }}
            {% if form.doctor_notes.help_text %}
            <div class="form-text">{{ form.doctor_notes.help_text }}</div>
            {% endif %}
            {% for error in form.doctor_notes.errors %}
            <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <!-- Billing Section -->
          <div class="col-12 mt-4">
            <h5 class="border-bottom pb-2 mb-3">
              <i data-feather="file-text" class="me-2" style="width:20px;height:20px;"></i>
              Billing Information
            </h5>
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">
              <i data-feather="dollar-sign" class="me-1" style="width:16px;height:16px;"></i>
              {{ form.price.label }}
            </label>
            {{ form.price }}
            <div class="form-text">Set the appointment fee (Default: 100 TND)</div>
            {% for error in form.price.errors %}
            <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">{{ form.payment_status.label }}</label>
            {{ form.payment_status }}
            {% if form.payment_status.help_text %}
            <div class="form-text">{{ form.payment_status.help_text }}</div>
            {% endif %}
            {% for error in form.payment_status.errors %}
            <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          {% if form.non_field_errors %}
          <div class="col-12">
            <div class="alert alert-danger">
              {% for error in form.non_field_errors %}
              <div>{{ error }}</div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Prescriptions Section -->
          <div class="col-12 mt-4">
            <h5 class="border-bottom pb-2 mb-3">
              <i data-feather="box" class="me-2" style="width:20px;height:20px;"></i>
              Prescriptions
            </h5>
          </div>

          {{ prescription_formset.management_form }}
          
          <div id="prescription-forms-container" class="col-12">
            {% for prescription_form in prescription_formset %}
            <div class="prescription-form" data-form-idx="{{ forloop.counter0 }}">
              <div class="prescription-header">
                <span class="prescription-number">
                  <i data-feather="circle" style="width:16px;height:16px;"></i>
                  Prescription #<span class="form-number">{{ forloop.counter }}</span>
                </span>
                {% if prescription_form.instance.pk %}
                <button type="button" class="btn btn-sm btn-danger btn-remove-prescription" onclick="markForDeletion(this)">
                  <i data-feather="x" style="width:14px;height:14px;"></i> Remove
                </button>
                {% endif %}
              </div>
              
              {{ prescription_form.id }}
              {{ prescription_form.DELETE }}
              
              <div class="row g-2">
                <div class="col-md-6">
                  <label class="form-label">{{ prescription_form.medication_name.label }}</label>
                  {{ prescription_form.medication_name }}
                  {% for error in prescription_form.medication_name.errors %}
                  <div class="text-danger small">{{ error }}</div>
                  {% endfor %}
                </div>
                <div class="col-md-6">
                  <label class="form-label">{{ prescription_form.dosage.label }}</label>
                  {{ prescription_form.dosage }}
                  {% for error in prescription_form.dosage.errors %}
                  <div class="text-danger small">{{ error }}</div>
                  {% endfor %}
                </div>
                <div class="col-md-6">
                  <label class="form-label">{{ prescription_form.frequency.label }}</label>
                  {{ prescription_form.frequency }}
                  {% for error in prescription_form.frequency.errors %}
                  <div class="text-danger small">{{ error }}</div>
                  {% endfor %}
                </div>
                <div class="col-md-6">
                  <label class="form-label">{{ prescription_form.duration.label }}</label>
                  {{ prescription_form.duration }}
                  {% for error in prescription_form.duration.errors %}
                  <div class="text-danger small">{{ error }}</div>
                  {% endfor %}
                </div>
                <div class="col-12">
                  <label class="form-label">{{ prescription_form.instructions.label }} (Optional)</label>
                  {{ prescription_form.instructions }}
                  {% for error in prescription_form.instructions.errors %}
                  <div class="text-danger small">{{ error }}</div>
                  {% endfor %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>

          <div class="col-12">
            <button type="button" class="btn btn-outline-primary btn-sm" id="add-prescription">
              <i data-feather="plus" class="me-1" style="width:14px;height:14px;"></i>
              Add another prescription
            </button>
          </div>

          <div class="col-12 d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-primary">
              <i data-feather="save" class="me-1" style="width:16px;height:16px;"></i>
              Save all changes
            </button>
            <a href="{% url 'appointment_detail' object.id %}" class="btn btn-outline-secondary">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card">
      <div class="card-body">
        <h4 class="card-title mb-3">Quick links</h4>
        <div class="list-group list-group-flush">
          <a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'patient_add' %}?name={{ object.name }}&email={{ object.email }}&phone={{ object.phone }}">
            <i data-feather="user-plus" class="me-3"></i>Create patient file
          </a>
          <a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'appointment_detail' object.id %}">
            <i data-feather="file-text" class="me-3"></i>View appointment detail
          </a>
          <a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'appointment_list' %}">
            <i data-feather="list" class="me-3"></i>Back to list
          </a>
        </div>
      </div>
    </div>
    
    {% if object.prescriptions.exists %}
    <div class="card mt-3">
      <div class="card-body">
        <h4 class="card-title mb-3">
          <i data-feather="file-text" class="me-2"></i>
          Existing Prescriptions
        </h4>
        <div class="list-group list-group-flush">
          {% for prescription in object.prescriptions.all %}
          <div class="list-group-item">
            <div class="fw-bold text-primary">{{ prescription.medication_name }}</div>
            <small class="text-muted">
              {{ prescription.dosage }} - {{ prescription.frequency }}
              <br>Duration: {{ prescription.duration }}
            </small>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', function() {
  // Initialize feather icons
  if (typeof feather !== 'undefined') {
    feather.replace();
  }

  // Add new prescription form dynamically
  const addButton = document.getElementById('add-prescription');
  if (addButton) {
    addButton.addEventListener('click', function() {
      const container = document.getElementById('prescription-forms-container');
      const totalForms = document.querySelector('#id_prescriptions-TOTAL_FORMS');
      const formIdx = parseInt(totalForms.value);
      
      // Get the first form as a template
      const emptyForm = container.querySelector('.prescription-form').cloneNode(true);
      
      // Update form index
      emptyForm.dataset.formIdx = formIdx;
      emptyForm.querySelector('.form-number').textContent = formIdx + 1;
      
      // Clear values and update name/id attributes
      emptyForm.querySelectorAll('input, textarea').forEach(input => {
        const name = input.getAttribute('name');
        if (name) {
          input.setAttribute('name', name.replace(/-\d+-/, `-${formIdx}-`));
          input.setAttribute('id', `id_${name.replace(/-\d+-/, `-${formIdx}-`)}`);
          if (input.type === 'checkbox') {
            input.checked = false;
          } else {
            input.value = '';
          }
        }
      });
      
      // Remove "Remove" button from new forms (only for existing prescriptions)
      const removeBtn = emptyForm.querySelector('.btn-remove-prescription');
      if (removeBtn) removeBtn.remove();
      
      // Remove to-delete class if it exists
      emptyForm.classList.remove('to-delete');
      
      container.appendChild(emptyForm);
      totalForms.value = formIdx + 1;
      
      // Reinitialize feather icons
      if (typeof feather !== 'undefined') {
        feather.replace();
      }
    });
  }
});

// Mark prescription for deletion
function markForDeletion(button) {
  const form = button.closest('.prescription-form');
  const deleteCheckbox = form.querySelector('input[name$="-DELETE"]');
  
  if (deleteCheckbox.checked) {
    // Unmark for deletion
    deleteCheckbox.checked = false;
    form.classList.remove('to-delete');
    button.innerHTML = '<i data-feather="x" style="width:14px;height:14px;"></i> Remove';
  } else {
    // Mark for deletion
    deleteCheckbox.checked = true;
    form.classList.add('to-delete');
    button.innerHTML = '<i data-feather="rotate-ccw" style="width:14px;height:14px;"></i> Undo';
  }
  
  // Reinitialize feather icons
  if (typeof feather !== 'undefined') {
    feather.replace();
  }
}
</script>
{% endblock %}


