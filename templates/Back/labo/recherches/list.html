{% extends "back/labo/base.html" %}

{% block extra_css %}
<style>
/* Backdrop */
.modal {
    display: none; /* hidden by default */
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(4px);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

/* Modal container */
.modal-content {
    background: #fff;
    border-radius: 0.5rem;
    width: 500px;
    max-width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    position: relative;
    padding: 1.5rem;
}

/* Modal header */
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e5e7eb;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
}

/* Close button */
.close-btn {
    cursor: pointer;
    font-size: 1.25rem;
    font-weight: bold;
    padding: 0.25rem;
    border-radius: 0.375rem;
    transition: background 0.2s;
}
.close-btn:hover {
    background: #f3f4f6;
}

/* Modal footer */
.modal-footer {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
    border-top: 1px solid #e5e7eb;
    padding-top: 0.5rem;
}
.modal-footer button {
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: background 0.2s;
}
.save-btn {
    background: #4f46e5;
    color: white;
}
.save-btn:hover {
    background: #4338ca;
}
.close-btn-footer {
    background: #6b7280;
    color: white;
}
.close-btn-footer:hover {
    background: #4b5563;
}
</style>
{% endblock %}

{% block content %}
<a href="{% url 'Labapp:recherche_stats' %}" class="btn btn-primary mb-3">Voir les statistiques</a>

<h2 class="mt-4 mb-3">Liste des Recherches</h2>

<table class="table table-striped table-bordered">
    <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Nom Recherche</th>
            <th>Maladie</th>
            <th>Type</th>
            <th>État</th>
            <th>Date Début</th>
            <th>Date Fin</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for recherche in recherches %}
        <tr>
            <td>{{ recherche.id }}</td>
            <td>{{ recherche.nom_recherche }}</td>
            <td>{{ recherche.maladie }}</td>
            <td>{{ recherche.get_type_recherche_display }}</td>
            <td>{{ recherche.get_etat_display }}</td>
            <td>{{ recherche.date_deb|date:"d/m/Y" }}</td>
            <td>{{ recherche.date_fin|date:"d/m/Y"|default:"-" }}</td>
            <td>
                <button class="btn btn-info btn-sm" onclick="openModal('details{{ recherche.id }}')">Détails</button>
                <button class="btn btn-warning btn-sm" onclick="openModal('edit{{ recherche.id }}')">Modifier</button>
                <button type="button" class="btn btn-danger btn-sm" onclick="openModal('delete{{ recherche.id }}')">Supprimer</button>

                <form id="deleteForm{{ recherche.id }}" method="POST" action="{% url 'Labapp:back_recherche_delete' recherche.id %}" style="display:none;">
                    {% csrf_token %}
                </form>
            </td>
        </tr>

        <!-- Détails Modal -->
        <div id="details{{ recherche.id }}" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Détails Recherche {{ recherche.nom_recherche }}</h5>
                    <span class="close-btn" onclick="closeModal('details{{ recherche.id }}')">&times;</span>
                </div>
                <p><strong>Maladie:</strong> {{ recherche.maladie }}</p>
                <p><strong>Objectif:</strong> {{ recherche.objectif }}</p>
                <p><strong>Type:</strong> {{ recherche.get_type_recherche_display }}</p>
                <p><strong>État:</strong> {{ recherche.get_etat_display }}</p>
                <p><strong>Date Début:</strong> {{ recherche.date_deb|date:"d/m/Y" }}</p>
                <p><strong>Date Fin:</strong> {{ recherche.date_fin|date:"d/m/Y"|default:"-" }}</p>
                <p><strong>Résultats Obtenus:</strong> {{ recherche.resultats_obtenus }}</p>
            </div>
        </div>

        <!-- Modifier Modal -->
        <div id="edit{{ recherche.id }}" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Modifier Recherche {{ recherche.nom_recherche }}</h5>
                    <span class="close-btn" onclick="closeModal('edit{{ recherche.id }}')">&times;</span>
                </div>
                <form method="POST" action="{% url 'Labapp:back_recherche_update' recherche.id %}">
                    {% csrf_token %}
                    <div class="mb-2">
                        <label>Nom Recherche</label>
                        <input type="text" name="nom_recherche" class="form-control" value="{{ recherche.nom_recherche }}">
                    </div>
                    <div class="mb-2">
                        <label>Maladie</label>
                        <input type="text" name="maladie" class="form-control" value="{{ recherche.maladie }}">
                    </div>
                    <div class="mb-2">
                        <label>Objectif</label>
                        <textarea name="objectif" class="form-control">{{ recherche.objectif }}</textarea>
                    </div>
                    <div class="mb-2">
                        <label>Type</label>
                        <select name="type_recherche" class="form-select">
                            {% for key, value in recherche.TYPE_RECHERCHE %}
                            <option value="{{ key }}" {% if recherche.type_recherche == key %}selected{% endif %}>{{ value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>État</label>
                        <select name="etat" class="form-select">
                            {% for key, value in recherche.ETAT_RECHERCHE %}
                            <option value="{{ key }}" {% if recherche.etat == key %}selected{% endif %}>{{ value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>Date Début</label>
                        <input type="date" name="date_deb" class="form-control" value="{{ recherche.date_deb|date:'Y-m-d' }}">
                    </div>
                    <div class="mb-2">
                        <label>Date Fin</label>
                        <input type="date" name="date_fin" class="form-control" value="{{ recherche.date_fin|date:'Y-m-d' }}">
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="save-btn">Enregistrer</button>
                        <button type="button" class="close-btn-footer" onclick="closeModal('edit{{ recherche.id }}')">Fermer</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Supprimer Modal -->
        <div id="delete{{ recherche.id }}" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Supprimer Recherche {{ recherche.nom_recherche }}</h5>
                    <span class="close-btn" onclick="closeModal('delete{{ recherche.id }}')">&times;</span>
                </div>
                <p>Êtes-vous sûr de vouloir supprimer cette recherche ? Cette action est irréversible.</p>
                <div class="modal-footer">
                    <button type="button" class="close-btn-footer" onclick="closeModal('delete{{ recherche.id }}')">Annuler</button>
                    <button type="button" class="save-btn" onclick="submitDelete('{{ recherche.id }}')">Supprimer</button>
                </div>
            </div>
        </div>

        {% endfor %}
    </tbody>
</table>

<script>
function openModal(id) {
    document.getElementById(id).style.display = 'flex';
}
function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

// Fermeture si clic en dehors du modal
window.onclick = function(event) {
    document.querySelectorAll('.modal').forEach(modal => {
        if(event.target == modal) modal.style.display = 'none';
    });
}

// Soumettre le formulaire de suppression
function submitDelete(id) {
    document.getElementById('deleteForm' + id).submit();
}
</script>
{% endblock %}